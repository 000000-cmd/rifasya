<div class="m-10 relative overflow-hidden">
  <div class="flex justify-between items-start mb-4">
    <div>
      <h1 class="text-3xl mb-2 text-primary border-b-4 border-primary inline-block">
        Editar Lista: {{ listRegistry()?.displayName || 'Cargando...' }}
      </h1>
    </div>
    <app-back-button></app-back-button>
  </div>

  <div class="mt-8 p-4 bg-white rounded-lg shadow">
    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Detalles del Registro</h2>
    @if (!isLoading()) {
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        @for (data of componentData; track data.label) {
          <false-input [label]="data.label" [text]="data.value" />
        }
      </div>
    } @else {
      <p class="text-center text-gray-500">Cargando detalles...</p>
    }
  </div>

  <div class="mt-8 bg-white rounded-lg shadow overflow-hidden">
    <h2 class="text-2xl font-semibold text-gray-700 p-4">Ítems de la Lista</h2>
    <app-custom-table [headers]="tableHeaders" [data]="listItems()">
      <ng-template #actions let-item>
        <div class="flex justify-center items-center">
          <app-button (click)="openEditDrawer(item)" variant="fancy" size="icon" title="Editar">
            <lucide-angular [img]="iconEdit" class="w-4 h-4"></lucide-angular>
          </app-button>
        </div>
      </ng-template>
    </app-custom-table>
  </div>

  @if (isDrawerOpen()) {
    <div class="fixed inset-0 bg-black/40 z-40 backdrop-blur-sm" (click)="closeDrawer()"></div>

    <div class="fixed top-0 right-0 h-full w-full max-w-md bg-white shadow-2xl z-50 flex flex-col transition-transform duration-300 ease-in-out"
         [class.translate-x-0]="isDrawerOpen()"
         [class.translate-x-full]="!isDrawerOpen()">

      <header class="flex justify-between items-center p-4 border-b bg-gray-50">
        <h2 class="text-xl font-semibold text-gray-800">Editar Ítem</h2>
        <app-button (click)="closeDrawer()" variant="ghost" size="icon">
          <lucide-angular [img]="iconX" class="w-5 h-5"></lucide-angular>
        </app-button>
      </header>

      <main class="p-6 flex-grow overflow-y-auto">
        <form [formGroup]="editForm" id="editItemForm" (ngSubmit)="saveChanges()">
          <div class="flex flex-col gap-6">
            <base-input label="Código" formControlName="code"></base-input>
            <base-input label="Nombre" formControlName="name"></base-input>

            <div>
              <label class="font-semibold text-gray-700 mb-1 block">Orden</label>
              <div class="flex items-center gap-4">
                <div class="flex-grow h-12 flex items-center px-3 border-2 rounded-md bg-gray-100 text-gray-800">
                  {{ editForm.get('order')?.value }}
                </div>
                <app-button type="button" variant="fancy" (click)="isReorderDrawerOpen.set(!isReorderDrawerOpen())" class="h-12 px-4">
                  <div class="flex items-center gap-2">
                    <lucide-angular [img]="iconChevrons" class="w-4 h-4"></lucide-angular>
                    Reordenar
                  </div>
                </app-button>
              </div>
            </div>

            <app-custom-checkbox formControlName="indicatorEnabled">
              Habilitado
            </app-custom-checkbox>
          </div>
        </form>
      </main>

      <footer class="p-4 border-t bg-gray-50 flex justify-end gap-3">
        <app-button type="button" variant="outline" (click)="closeDrawer()">Cancelar</app-button>
        <app-button type="submit" form="editItemForm" variant="fancy" [disabled]="editForm.invalid">Guardar Cambios</app-button>
      </footer>
    </div>

    @if (isReorderDrawerOpen()) {
      <div class="fixed top-0 right-[28rem] h-full w-full max-w-xs bg-gray-100 shadow-2xl z-50 flex flex-col border-l transition-transform duration-300 ease-in-out"
           [class.translate-x-0]="isReorderDrawerOpen()"
           [class.translate-x-full]="!isReorderDrawerOpen()">

        <header class="p-2 border-b bg-white flex justify-between items-center">
          <h3 class="font-semibold text-gray-700">Arrastra para ordenar</h3>
          <div class="flex gap-1">
            <app-button (click)="moveSelectedItem('up')" [disabled]="isMoveUpDisabled()" variant="ghost" size="icon">
              <lucide-angular [img]="iconArrowUp" class="w-4 h-4"></lucide-angular>
            </app-button>
            <app-button (click)="moveSelectedItem('down')" [disabled]="isMoveDownDisabled()" variant="ghost" size="icon">
              <lucide-angular [img]="iconArrowDown" class="w-4 h-4"></lucide-angular>
            </app-button>
          </div>
        </header>

        <div cdkDropList [cdkDropListData]="reorderableList()" (cdkDropListDropped)="drop($event)" class="flex-grow overflow-y-auto p-2">
          @for (item of reorderableList(); track item.id) {
            <div cdkDrag [cdkDragDisabled]="item.id !== selectedItem()?.id"
                 class="p-3 mb-2 rounded-md flex items-center justify-between text-gray-800 transition-all"
                 [ngClass]="{
                   'bg-white shadow-md': item.id !== selectedItem()?.id,
                   'bg-purple-100 border-2 border-purple-500': item.id === selectedItem()?.id,
                   'cursor-grab': item.id === selectedItem()?.id,
                   'cursor-not-allowed': item.id !== selectedItem()?.id
                 }">
              <span>{{ item.name }}</span>
              @if (item.id === selectedItem()?.id) {
                <lucide-angular [img]="iconMove" class="w-4 h-4 text-purple-600"></lucide-angular>
              }
            </div>
          }
        </div>
      </div>
    }
  }
</div>
