<div class="m-10 relative overflow-hidden">
  @if (isLoading()) {
    <div class="animate-pulse">
      <div class="h-10 w-1/3 bg-gray-200 rounded-md mb-4"></div>
      <div class="mt-8 p-4 bg-white rounded-lg shadow">
        <div class="h-8 w-1/4 bg-gray-200 rounded-md mb-4"></div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <div class="h-12 bg-gray-200 rounded-md"></div>
          <div class="h-12 bg-gray-200 rounded-md"></div>
          <div class="h-12 bg-gray-200 rounded-md"></div>
          <div class="h-12 bg-gray-200 rounded-md"></div>
        </div>
      </div>
      <div class="mt-8 bg-white rounded-lg shadow overflow-hidden">
        <div class="p-4 flex justify-between items-center">
          <div class="h-8 w-1/4 bg-gray-200 rounded-md"></div>
          <div class="h-10 w-32 bg-gray-200 rounded-md"></div>
        </div>
        <div class="p-4 space-y-2">
          @for (i of [1, 2, 3, 4, 5]; track i) {
            <div class="h-12 bg-gray-200 rounded-md"></div>
          }
        </div>
      </div>
    </div>
  } @else {
    <div>
      <div class="flex justify-between items-start mb-4">
        <div><h1 class="text-3xl mb-2 text-primary border-b-4 border-primary inline-block">Editar Lista: {{ listRegistry()?.displayName || '' }}</h1></div>
        <app-back-button></app-back-button>
      </div>
      <div class="mt-8 p-4 bg-white rounded-lg shadow">
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Detalles del Registro</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <false-input label="Nombre" [text]="listRegistry()?.displayName ?? ''" />
          <false-input label="Nombre Técnico" [text]="listRegistry()?.technicalName ?? ''" />
          <false-input label="Descripción" [text]="listRegistry()?.description ?? ''" />
          <false-input label="Api Endpoint" [text]="listRegistry()?.apiEndpoint ?? ''" />
        </div>
      </div>
      <div class="mt-8 bg-white rounded-lg shadow overflow-hidden">
        <div class="flex justify-between items-center p-4">
          <h2 class="text-2xl font-semibold text-gray-700">Ítems de la Lista</h2>
          <app-button variant="fancy" (click)="openNewDrawer()">Crear Nuevo</app-button>
        </div>
        <app-custom-table [headers]="tableHeaders" [data]="listItems()">
          <ng-template #actions let-item>
            <div class="flex justify-center items-center gap-2">
              <app-button (click)="openEditDrawer(item)" variant="fancy" size="icon" title="Editar">
                <lucide-angular [img]="iconEdit" class="w-4 h-4"></lucide-angular>
              </app-button>
              <app-button (click)="deleteItem(item)"
                          variant="outline"
                          size="icon"
                          title="Eliminar"
                          [disabled]="deletingItemId() !== null">
                @if (deletingItemId() === item.id) {
                  <lucide-angular [img]="iconLoader" class="w-4 h-4 animate-spin"></lucide-angular>
                } @else {
                  <lucide-angular [img]="iconTrash" class="w-4 h-4 text-red-600"></lucide-angular>
                }
              </app-button>
            </div>
          </ng-template>
        </app-custom-table>
      </div>
    </div>
  }

  @if (isDrawerOpen()) {
    <div class="fixed inset-0 bg-black/40 z-40 backdrop-blur-sm" (click)="closeDrawer()"></div>
    <div class="fixed top-0 right-0 h-full w-full max-w-md bg-white shadow-2xl z-50 flex flex-col transition-transform duration-300 ease-in-out"
         [class.translate-x-0]="isDrawerOpen()" [class.translate-x-full]="!isDrawerOpen()">
      <header class="flex justify-between items-center p-4 border-b bg-gray-50">
        <h2 class="text-xl font-semibold text-gray-800">{{ isEditing() ? 'Editar Ítem' : 'Crear Nuevo Ítem' }}</h2>
        <app-button (click)="closeDrawer()" variant="ghost" size="icon"><lucide-angular [img]="iconX" class="w-5 h-5"></lucide-angular></app-button>
      </header>
      <main class="p-6 flex-grow overflow-y-auto">
        <form [formGroup]="editForm" id="editItemForm" (ngSubmit)="saveChanges()">
          <div class="flex flex-col gap-6">
            <div>
              <base-input label="Código" formControlName="code"></base-input>
              @if (editForm.get('code')?.invalid && (editForm.get('code')?.dirty || editForm.get('code')?.touched)) {
                <div class="text-red-600 text-sm mt-1">
                  @if (editForm.get('code')?.errors?.['required']) { <span>El código es obligatorio.</span> }
                  @if (editForm.get('code')?.errors?.['maxlength']) { <span>Máximo 8 caracteres.</span> }
                  @if (editForm.get('code')?.errors?.['pattern']) { <span>No se permiten espacios.</span> }
                </div>
              }
            </div>
            <base-input label="Nombre" formControlName="name"></base-input>
            <div>
              @if(isEditing() || editForm.get('order')?.value > 0) {
                <div class="flex items-center gap-2">
                  <false-input class="flex-grow" label="Orden" [text]="editForm.get('order')?.value" />
                  <app-button type="button" variant="fancy" (click)="openReorderDrawer()" class="h-12 px-4 shrink-0">Reordenar</app-button>
                </div>
              } @else {
                <label class="font-semibold text-gray-700 mb-1 block">Orden</label>
                <app-button type="button" variant="fancy" (click)="openReorderDrawer()" class="h-12 w-full">
                  <lucide-angular [img]="iconChevrons" class="w-4 h-4 mr-2"></lucide-angular>
                  Asignar Posición
                </app-button>
              }
              @if (editForm.hasError('orderRequired') && (editForm.dirty || editForm.touched)) {
                <div class="text-red-600 text-sm mt-1">Es obligatorio asignar una posición al nuevo ítem.</div>
              }
            </div>
            <app-custom-checkbox formControlName="indicatorEnabled">Habilitado</app-custom-checkbox>
          </div>
        </form>
      </main>
      <footer class="p-4 border-t bg-gray-50 flex justify-end gap-3">
        <app-button type="button" variant="outline" (click)="closeDrawer()">Cancelar</app-button>
        <app-button
          type="submit"
          form="editItemForm"
          variant="fancy"
          [disabled]="editForm.invalid || isSaving()">
          {{ isSaving() ? 'Guardando...' : (isEditing() ? 'Guardar Cambios' : 'Crear Ítem') }}
        </app-button>
      </footer>
    </div>

    @if (isReorderDrawerOpen()) {
      <div class="fixed top-0 right-[28rem] h-full w-full max-w-xs bg-gray-100 shadow-2xl z-50 flex flex-col border-l"
           [class.translate-x-0]="isReorderDrawerOpen()" [class.translate-x-full]="!isReorderDrawerOpen()">
        <header class="p-2 border-b bg-white flex justify-between items-center">
          <h3 class="font-semibold text-gray-700">Asigna una posición</h3>
          <app-button (click)="isReorderDrawerOpen.set(false)" variant="ghost" size="icon" title="Ocultar"><lucide-angular [img]="iconChevronRight" class="w-5 h-5"></lucide-angular></app-button>
        </header>
        <div cdkDropListGroup class="flex-grow p-2 overflow-y-auto">
          @if (!isEditing() && newItemPlaceholder().length > 0) {
            <div class="mb-4">
              <p class="text-sm text-gray-500 px-2 mb-2">Nuevo Ítem (arrastra abajo)</p>
              <div cdkDropList id="newItemList" [cdkDropListData]="newItemPlaceholder()" (cdkDropListDropped)="drop($event)">
                @for (item of newItemPlaceholder(); track item.id) {
                  <div cdkDrag class="p-3 mb-2 rounded-md flex items-center justify-between transition-all cursor-grab bg-purple-100 border-2 border-purple-400">
                    <span class="font-semibold text-gray-800">{{ item.name || 'Nuevo Ítem...' }}</span>
                    <lucide-angular [img]="iconMove" class="w-5 h-5 text-purple-600"></lucide-angular>
                  </div>
                }
              </div>
              <hr class="my-4 border-dashed border-gray-300">
            </div>
          }
          <p class="text-sm text-gray-500 px-2 mb-2">Posición en la lista</p>
          <div cdkDropList id="mainList" [cdkDropListData]="reorderableList()" (cdkDropListDropped)="drop($event)" class="min-h-[100px]">
            @for (item of reorderableList(); track item.id) {
              <div cdkDrag [cdkDragDisabled]="item.id !== selectedItem()?.id" class="p-3 mb-2 rounded-md flex items-center justify-between text-gray-800 transition-all" [ngClass]="{ 'bg-purple-100 border-2 border-purple-400': item.id === selectedItem()?.id, 'bg-white shadow-sm': item.id !== selectedItem()?.id, 'cursor-grab': item.id === selectedItem()?.id, 'cursor-not-allowed opacity-70': item.id !== selectedItem()?.id }">
                <span>{{ item.name }}</span>
                @if (item.id === selectedItem()?.id) { <lucide-angular [img]="iconMove" class="w-5 h-5 text-purple-600"></lucide-angular> }
              </div>
            }
          </div>
        </div>
      </div>
    }
  }
</div>
